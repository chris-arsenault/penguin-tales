{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "action.schema.json",
  "title": "Declarative Action",
  "description": "Schema for declarative action configurations used by the universal catalyst system",
  "type": "object",
  "required": ["id", "name", "description", "actor", "targeting", "outcome", "probability"],
  "additionalProperties": false,
  "properties": {
    "id": {
      "type": "string",
      "minLength": 1,
      "pattern": "^[a-z][a-z0-9_]*$",
      "description": "Unique identifier for this action"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "description": "Display name for this action"
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "description": "Description of what this action does"
    },
    "enabled": {
      "type": "boolean",
      "description": "Whether this action is active (default: true)"
    },
    "actor": { "$ref": "#/$defs/ActionActorConfig" },
    "targeting": { "$ref": "#/$defs/ActionTargetConfig" },
    "outcome": { "$ref": "#/$defs/ActionOutcomeConfig" },
    "probability": { "$ref": "#/$defs/ActionProbabilityConfig" }
  },

  "$defs": {
    "PressureBand": {
      "type": "object",
      "required": ["pressure"],
      "additionalProperties": false,
      "properties": {
        "pressure": {
          "type": "string",
          "minLength": 1,
          "description": "Pressure ID"
        },
        "min": {
          "type": "number",
          "minimum": -100,
          "maximum": 100,
          "description": "Minimum value (-100 to 100)"
        },
        "max": {
          "type": "number",
          "minimum": -100,
          "maximum": 100,
          "description": "Maximum value (-100 to 100)"
        }
      }
    },

    "PressureModifier": {
      "type": "object",
      "required": ["pressure", "multiplier"],
      "additionalProperties": false,
      "properties": {
        "pressure": {
          "type": "string",
          "minLength": 1,
          "description": "Pressure ID"
        },
        "multiplier": {
          "type": "number",
          "description": "Multiplier for how pressure affects weight/attempt chance. Positive: high pressure increases likelihood. Negative: inverse relationship."
        }
      }
    },

    "ActionActorConfig": {
      "type": "object",
      "required": ["kinds"],
      "additionalProperties": false,
      "properties": {
        "kinds": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1,
          "description": "Entity kinds that can be actors (the entity that interacts with the target)"
        },
        "subtypes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Optional subtype filter"
        },
        "statuses": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Filter by status"
        },
        "requiredPressures": {
          "type": "array",
          "items": { "$ref": "#/$defs/PressureBand" },
          "description": "Pressure bands - action available only when pressures are within ranges"
        },
        "filters": {
          "type": "array",
          "items": { "$ref": "#/$defs/SelectionFilter" },
          "description": "Selection filters (same as generator targeting)"
        },
        "instigator": {
          "$ref": "#/$defs/InstigatorConfig",
          "description": "Optional instigator - entity that triggers the action on behalf of actor"
        }
      }
    },

    "InstigatorConfig": {
      "type": "object",
      "required": ["relationshipKind", "direction"],
      "additionalProperties": false,
      "properties": {
        "relationshipKind": {
          "type": "string",
          "minLength": 1,
          "description": "Relationship kind connecting instigator to actor"
        },
        "direction": {
          "type": "string",
          "enum": ["in", "out"],
          "description": "Direction: 'in' = instigator has relationship TO actor, 'out' = actor has relationship TO instigator"
        },
        "kinds": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Entity kinds that can be instigators"
        },
        "subtypes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Optional subtype filter"
        },
        "statuses": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Optional status filter"
        },
        "filters": {
          "type": "array",
          "items": { "$ref": "#/$defs/SelectionFilter" },
          "description": "Selection filters on instigator"
        },
        "required": {
          "type": "boolean",
          "description": "Is an instigator required? Default false - actor can act alone"
        }
      }
    },

    "ActionTargetConfig": {
      "type": "object",
      "required": ["kind"],
      "additionalProperties": false,
      "properties": {
        "kind": {
          "type": "string",
          "minLength": 1,
          "description": "Target entity kind"
        },
        "subtypes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Filter by subtype"
        },
        "statuses": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Filter by status"
        },
        "selectTwo": {
          "type": "boolean",
          "description": "Select two targets (for actions like trade routes)"
        },
        "excludeSelf": {
          "type": "boolean",
          "description": "Exclude self (for faction-to-faction actions)"
        },
        "filters": {
          "type": "array",
          "items": { "$ref": "#/$defs/SelectionFilter" },
          "description": "Selection filters (same as generator targeting)"
        }
      }
    },

    "OutcomeRelationship": {
      "type": "object",
      "required": ["kind", "src", "dst", "strength"],
      "additionalProperties": false,
      "properties": {
        "kind": {
          "type": "string",
          "minLength": 1,
          "description": "Relationship kind"
        },
        "src": {
          "type": "string",
          "enum": ["actor", "instigator", "target", "target2"],
          "description": "Source entity"
        },
        "dst": {
          "type": "string",
          "enum": ["actor", "instigator", "target", "target2"],
          "description": "Destination entity"
        },
        "strength": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Initial strength"
        },
        "bidirectional": {
          "type": "boolean",
          "description": "Create reverse relationship too"
        }
      }
    },

    "RelationshipStrengthening": {
      "type": "object",
      "required": ["kind", "channel", "amount"],
      "additionalProperties": false,
      "properties": {
        "kind": {
          "type": "string",
          "minLength": 1,
          "description": "Relationship kind to strengthen"
        },
        "channel": {
          "type": "string",
          "enum": ["instigator_actor", "actor_target"],
          "description": "Which entities to strengthen relationship between"
        },
        "amount": {
          "type": "number",
          "description": "Amount to change strength (can be negative to weaken)"
        }
      }
    },

    "StatusChange": {
      "type": "object",
      "required": ["entity", "status"],
      "additionalProperties": false,
      "properties": {
        "entity": {
          "type": "string",
          "enum": ["actor", "instigator", "target", "target2"],
          "description": "Which entity to change status of"
        },
        "status": {
          "type": "string",
          "minLength": 1,
          "description": "New status to set"
        }
      }
    },

    "ActionOutcomeConfig": {
      "type": "object",
      "required": ["descriptionTemplate"],
      "additionalProperties": false,
      "properties": {
        "relationships": {
          "type": "array",
          "items": { "$ref": "#/$defs/OutcomeRelationship" },
          "description": "Relationships to create"
        },
        "strengthenRelationships": {
          "type": "array",
          "items": { "$ref": "#/$defs/RelationshipStrengthening" },
          "description": "Relationships to strengthen"
        },
        "statusChanges": {
          "type": "array",
          "items": { "$ref": "#/$defs/StatusChange" },
          "description": "Status changes to apply to entities"
        },
        "pressureChanges": {
          "type": "object",
          "additionalProperties": { "type": "number" },
          "description": "Pressure changes"
        },
        "applyProminenceToActor": {
          "type": "boolean",
          "description": "Apply system-level prominence changes to actor on success/failure"
        },
        "applyProminenceToInstigator": {
          "type": "boolean",
          "description": "Apply system-level prominence changes to instigator on success/failure"
        },
        "descriptionTemplate": {
          "type": "string",
          "minLength": 1,
          "description": "Description template (supports {actor.name}, {target.name}, etc.)"
        }
      }
    },

    "ActionProbabilityConfig": {
      "type": "object",
      "required": ["baseSuccessChance", "baseWeight"],
      "additionalProperties": false,
      "properties": {
        "baseSuccessChance": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Base success chance (0-1)"
        },
        "baseWeight": {
          "type": "number",
          "minimum": 0,
          "description": "Selection weight for weighted random"
        },
        "pressureModifiers": {
          "type": "array",
          "items": { "$ref": "#/$defs/PressureModifier" },
          "description": "Pressure modifiers that affect this action's weight and attempt chance"
        }
      }
    },

    "NonEmptyString": {
      "type": "string",
      "minLength": 1
    },

    "Prominence": {
      "enum": ["forgotten", "marginal", "recognized", "renowned", "mythic"]
    },

    "SelectionFilter": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "entities"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "exclude" },
            "entities": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["src", "dst", "both"] }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tag" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tags" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_any_tag" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_tag" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_any_tag" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "culture"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_culture" },
            "culture": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "matches_culture" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "status"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_status" },
            "status": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "minProminence"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_prominence" },
            "minProminence": { "$ref": "#/$defs/Prominence" }
          }
        },
        {
          "type": "object",
          "required": ["type", "relationshipKind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "shares_related" },
            "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "assert"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "graph_path" },
            "assert": { "$ref": "#/$defs/GraphPathAssertion" }
          }
        }
      ]
    },

    "GraphPathAssertion": {
      "type": "object",
      "required": ["check", "path"],
      "additionalProperties": false,
      "properties": {
        "check": { "enum": ["exists", "not_exists", "count_min", "count_max"] },
        "path": { "type": "array", "items": { "$ref": "#/$defs/PathStep" }, "minItems": 1 },
        "count": { "type": "integer", "minimum": 0 },
        "where": { "type": "array", "items": { "$ref": "#/$defs/PathConstraint" } }
      }
    },

    "PathStep": {
      "type": "object",
      "required": ["via", "direction"],
      "additionalProperties": false,
      "properties": {
        "via": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["out", "in", "any"] },
        "targetKind": { "$ref": "#/$defs/NonEmptyString" },
        "targetSubtype": { "$ref": "#/$defs/NonEmptyString" },
        "targetStatus": { "$ref": "#/$defs/NonEmptyString" },
        "as": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "PathConstraint": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "set"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "not_in" },
            "set": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "set"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "in" },
            "set": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["out", "in", "any"] }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["out", "in", "any"] }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "not_self" }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "kind_equals" },
            "kind": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "subtype"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "subtype_equals" },
            "subtype": { "$ref": "#/$defs/NonEmptyString" }
          }
        }
      ]
    }
  }
}
