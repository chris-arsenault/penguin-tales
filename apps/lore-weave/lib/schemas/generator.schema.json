{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "generator.schema.json",
  "title": "DeclarativeTemplate",
  "description": "A declarative template/generator definition for world generation",
  "type": "object",
  "required": ["id", "name", "applicability", "selection", "creation", "relationships", "stateUpdates"],
  "additionalProperties": false,
  "properties": {
    "id": { "type": "string", "minLength": 1, "description": "Unique identifier for this generator" },
    "name": { "type": "string", "minLength": 1, "description": "Human-readable name" },
    "enabled": { "type": "boolean", "description": "Whether this generator is active (default: true)" },
    "applicability": {
      "type": "array",
      "description": "Rules that determine when this template can run",
      "items": { "$ref": "#/$defs/ApplicabilityRule" }
    },
    "selection": { "$ref": "#/$defs/SelectionRule", "description": "How to find target entities" },
    "creation": { "type": "array", "description": "Entities to create", "items": { "$ref": "#/$defs/CreationRule" } },
    "relationships": { "type": "array", "description": "Relationships to form", "items": { "$ref": "#/$defs/RelationshipRule" } },
    "stateUpdates": { "type": "array", "description": "State updates to apply", "items": { "$ref": "#/$defs/StateUpdateRule" } },
    "variables": { "type": "object", "description": "Named entity references computed during execution", "additionalProperties": { "$ref": "#/$defs/VariableDefinition" } },
    "variants": { "$ref": "#/$defs/TemplateVariants", "description": "Conditional variants that modify template output based on world state" }
  },
  "$defs": {
    "NonEmptyString": { "type": "string", "minLength": 1 },
    "AnyOrString": {
      "type": "string",
      "minLength": 1,
      "description": "Either the literal 'any' (meaning match all) or a specific non-empty value"
    },

    "ApplicabilityRule": {
      "oneOf": [
        { "$ref": "#/$defs/PressureThresholdRule" },
        { "$ref": "#/$defs/PressureAnyAboveRule" },
        { "$ref": "#/$defs/PressureCompareRule" },
        { "$ref": "#/$defs/EntityCountMinRule" },
        { "$ref": "#/$defs/EntityCountMaxRule" },
        { "$ref": "#/$defs/EraMatchRule" },
        { "$ref": "#/$defs/RandomChanceRule" },
        { "$ref": "#/$defs/CooldownElapsedRule" },
        { "$ref": "#/$defs/CreationsPerEpochRule" },
        { "$ref": "#/$defs/CompositeApplicabilityRule" }
      ]
    },

    "PressureThresholdRule": {
      "type": "object",
      "required": ["type", "pressureId"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure_threshold" },
        "pressureId": { "$ref": "#/$defs/NonEmptyString" },
        "min": { "type": "number", "minimum": -100, "maximum": 100 },
        "max": { "type": "number", "minimum": -100, "maximum": 100 }
      }
    },

    "PressureAnyAboveRule": {
      "type": "object",
      "required": ["type", "pressureIds", "threshold"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure_any_above" },
        "pressureIds": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "threshold": { "type": "number", "minimum": -100, "maximum": 100 }
      }
    },

    "PressureCompareRule": {
      "type": "object",
      "required": ["type", "pressureA", "pressureB"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "pressure_compare" },
        "pressureA": { "$ref": "#/$defs/NonEmptyString" },
        "pressureB": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "EntityCountMinRule": {
      "type": "object",
      "required": ["type", "kind", "min"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_count_min" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtype": { "$ref": "#/$defs/NonEmptyString" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "min": { "type": "integer", "minimum": 0 }
      }
    },

    "EntityCountMaxRule": {
      "type": "object",
      "required": ["type", "kind", "max"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "entity_count_max" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtype": { "$ref": "#/$defs/NonEmptyString" },
        "max": { "type": "integer", "minimum": 0 },
        "overshootFactor": { "type": "number", "minimum": 1 }
      }
    },

    "EraMatchRule": {
      "type": "object",
      "required": ["type", "eras"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "era_match" },
        "eras": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
      }
    },

    "RandomChanceRule": {
      "type": "object",
      "required": ["type", "chance"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "random_chance" },
        "chance": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "CooldownElapsedRule": {
      "type": "object",
      "required": ["type", "cooldownTicks"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "cooldown_elapsed" },
        "cooldownTicks": { "type": "integer", "minimum": 1 }
      }
    },

    "CreationsPerEpochRule": {
      "type": "object",
      "required": ["type", "maxPerEpoch"],
      "additionalProperties": false,
      "properties": {
        "type": { "const": "creations_per_epoch" },
        "maxPerEpoch": { "type": "integer", "minimum": 1 }
      }
    },

    "CompositeApplicabilityRule": {
      "type": "object",
      "required": ["type", "rules"],
      "additionalProperties": false,
      "properties": {
        "type": { "enum": ["and", "or"] },
        "rules": { "type": "array", "items": { "$ref": "#/$defs/ApplicabilityRule" }, "minItems": 1 }
      }
    },

    "GraphPathAssertion": {
      "type": "object",
      "required": ["check", "path"],
      "additionalProperties": false,
      "properties": {
        "check": { "enum": ["exists", "not_exists", "count_min", "count_max"] },
        "path": { "type": "array", "items": { "$ref": "#/$defs/PathStep" }, "minItems": 1 },
        "count": { "type": "integer", "minimum": 0 },
        "where": { "type": "array", "items": { "$ref": "#/$defs/PathConstraint" } }
      }
    },

    "PathStep": {
      "type": "object",
      "required": ["via", "direction", "targetKind", "targetSubtype"],
      "additionalProperties": false,
      "properties": {
        "via": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["out", "in", "any"] },
        "targetKind": { "$ref": "#/$defs/AnyOrString" },
        "targetSubtype": { "$ref": "#/$defs/AnyOrString" },
        "targetStatus": { "$ref": "#/$defs/AnyOrString" },
        "as": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "PathConstraint": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "set"],
          "additionalProperties": false,
          "properties": { "type": { "const": "not_in" }, "set": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "set"],
          "additionalProperties": false,
          "properties": { "type": { "const": "in" }, "set": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "kind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["out", "in", "any"] }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["out", "in", "any"] }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": { "type": { "const": "not_self" } }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": { "type": { "const": "kind_equals" }, "kind": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["type", "subtype"],
          "additionalProperties": false,
          "properties": { "type": { "const": "subtype_equals" }, "subtype": { "$ref": "#/$defs/NonEmptyString" } }
        }
      ]
    },

    "SelectionRule": {
      "type": "object",
      "required": ["strategy", "kind"],
      "additionalProperties": false,
      "properties": {
        "strategy": { "enum": ["by_kind", "by_preference_order", "by_relationship", "by_proximity", "by_prominence"] },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtypes": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "statusFilter": { "$ref": "#/$defs/NonEmptyString" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
        "mustHave": { "type": "boolean" },
        "direction": { "enum": ["src", "dst", "both"] },
        "subtypePreferences": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "referenceEntity": { "$ref": "#/$defs/NonEmptyString" },
        "maxDistance": { "type": "number", "minimum": 0 },
        "minProminence": { "$ref": "#/$defs/Prominence" },
        "filters": { "type": "array", "items": { "$ref": "#/$defs/SelectionFilter" } },
        "pickStrategy": { "enum": ["random", "first", "all", "weighted"] },
        "maxResults": { "type": "integer", "minimum": 1 }
      }
    },

    "SelectionFilter": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "entities"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "exclude" },
            "entities": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" },
            "direction": { "enum": ["src", "dst", "both"] }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_relationship" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tag" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tags" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_any_tag" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_tag" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "tags"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "lacks_any_tag" },
            "tags": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "culture"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_culture" },
            "culture": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "matches_culture" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "status"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_status" },
            "status": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "minProminence"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_prominence" },
            "minProminence": { "$ref": "#/$defs/Prominence" }
          }
        },
        {
          "type": "object",
          "required": ["type", "relationshipKind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "shares_related" },
            "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "assert"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "graph_path" },
            "assert": { "$ref": "#/$defs/GraphPathAssertion" }
          }
        }
      ]
    },

    "CreationRule": {
      "type": "object",
      "required": ["entityRef", "kind", "subtype", "placement"],
      "additionalProperties": false,
      "properties": {
        "entityRef": { "$ref": "#/$defs/NonEmptyString", "description": "Variable name for this entity (e.g., $newFaction)" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtype": { "$ref": "#/$defs/SubtypeSpec" },
        "status": { "$ref": "#/$defs/NonEmptyString" },
        "prominence": { "$ref": "#/$defs/Prominence" },
        "culture": { "$ref": "#/$defs/CultureSpec" },
        "description": { "$ref": "#/$defs/DescriptionSpec" },
        "tags": { "type": "object", "additionalProperties": { "type": "boolean" } },
        "placement": { "$ref": "#/$defs/PlacementSpec" },
        "count": { "oneOf": [{ "type": "integer", "minimum": 1 }, { "$ref": "#/$defs/CountRange" }] },
        "lineage": { "$ref": "#/$defs/LineageSpec" }
      }
    },

    "SubtypeSpec": {
      "oneOf": [
        { "$ref": "#/$defs/NonEmptyString" },
        {
          "type": "object",
          "required": ["inherit"],
          "additionalProperties": false,
          "properties": {
            "inherit": { "$ref": "#/$defs/NonEmptyString" },
            "chance": { "type": "number", "minimum": 0, "maximum": 1 },
            "fallback": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["fromPressure"],
          "additionalProperties": false,
          "properties": {
            "fromPressure": { "type": "object", "additionalProperties": { "$ref": "#/$defs/NonEmptyString" }, "minProperties": 1 }
          }
        },
        {
          "type": "object",
          "required": ["random"],
          "additionalProperties": false,
          "properties": {
            "random": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 }
          }
        }
      ]
    },

    "CultureSpec": {
      "oneOf": [
        {
          "type": "object",
          "required": ["inherit"],
          "additionalProperties": false,
          "properties": { "inherit": { "$ref": "#/$defs/NonEmptyString" } }
        },
        {
          "type": "object",
          "required": ["fixed"],
          "additionalProperties": false,
          "properties": { "fixed": { "$ref": "#/$defs/NonEmptyString" } }
        }
      ]
    },

    "DescriptionSpec": {
      "oneOf": [
        { "type": "string" },
        {
          "type": "object",
          "required": ["template", "replacements"],
          "additionalProperties": false,
          "properties": {
            "template": { "$ref": "#/$defs/NonEmptyString" },
            "replacements": { "type": "object", "additionalProperties": { "$ref": "#/$defs/NonEmptyString" }, "minProperties": 1 }
          }
        }
      ]
    },

    "PlacementSpec": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "entity"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "near_entity" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "maxDistance": { "type": "number", "minimum": 0 },
            "minDistance": { "type": "number", "minimum": 0 }
          }
        },
        {
          "type": "object",
          "required": ["type", "culture"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "in_culture_region" },
            "culture": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "references"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "derived_from_references" },
            "references": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
            "culture": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "random_in_bounds" },
            "bounds": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "x": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                "y": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                "z": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
              }
            }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "in_sparse_area" },
            "minDistanceFromEntities": { "type": "number", "minimum": 0 },
            "preferPeriphery": { "type": "boolean" },
            "createRegion": { "type": "boolean" }
          }
        },
        {
          "type": "object",
          "required": ["anchor"],
          "additionalProperties": false,
          "properties": {
            "anchor": {
              "oneOf": [
                {
                  "type": "object",
                  "required": ["type", "ref"],
                  "additionalProperties": false,
                  "properties": {
                    "type": { "const": "entity" },
                    "ref": { "$ref": "#/$defs/NonEmptyString" },
                    "stickToRegion": { "type": "boolean" }
                  }
                },
                {
                  "type": "object",
                  "required": ["type", "id"],
                  "additionalProperties": false,
                  "properties": {
                    "type": { "const": "culture" },
                    "id": { "$ref": "#/$defs/NonEmptyString" }
                  }
                },
                {
                  "type": "object",
                  "required": ["type", "refs"],
                  "additionalProperties": false,
                  "properties": {
                    "type": { "const": "refs_centroid" },
                    "refs": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
                    "jitter": { "type": "number", "minimum": 0 }
                  }
                },
                {
                  "type": "object",
                  "required": ["type"],
                  "additionalProperties": false,
                  "properties": {
                    "type": { "const": "sparse" },
                    "preferPeriphery": { "type": "boolean" }
                  }
                },
                {
                  "type": "object",
                  "required": ["type"],
                  "additionalProperties": false,
                  "properties": {
                    "type": { "const": "bounds" },
                    "bounds": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "x": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                        "y": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                        "z": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
                      }
                    }
                  }
                }
              ]
            },
            "spacing": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "minDistance": { "type": "number", "minimum": 0 },
                "avoidRefs": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" } }
              }
            },
            "regionPolicy": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "allowEmergent": { "type": "boolean", "description": "Allow emergent region creation when seed regions are at capacity" },
                "createRegion": { "type": "boolean", "description": "Create a new region centered on the placed entity (useful for sparse placement establishing new territories)" },
                "preferSparse": { "type": "boolean", "description": "Bias region selection toward sparser regions (weighted by inverse entity count)" }
              }
            },
            "fallback": {
              "type": "array",
              "items": {
                "enum": ["anchor_region", "ref_region", "seed_region", "sparse", "bounds", "random"]
              }
            }
          }
        }
      ]
    },

    "CountRange": {
      "type": "object",
      "required": ["min", "max"],
      "additionalProperties": false,
      "properties": {
        "min": { "type": "integer", "minimum": 1 },
        "max": { "type": "integer", "minimum": 1 }
      }
    },

    "LineageSpec": {
      "type": "object",
      "required": ["parent"],
      "additionalProperties": false,
      "properties": {
        "parent": { "$ref": "#/$defs/NonEmptyString" },
        "relationshipKind": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "Prominence": {
      "enum": ["forgotten", "marginal", "recognized", "renowned", "mythic"]
    },

    "RelationshipRule": {
      "type": "object",
      "required": ["kind", "src", "dst"],
      "additionalProperties": false,
      "properties": {
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "src": { "$ref": "#/$defs/NonEmptyString" },
        "dst": { "$ref": "#/$defs/NonEmptyString" },
        "strength": { "type": "number", "minimum": 0, "maximum": 1 },
        "bidirectional": { "type": "boolean" },
        "catalyzedBy": { "$ref": "#/$defs/NonEmptyString" },
        "condition": { "$ref": "#/$defs/RelationshipCondition" }
      }
    },

    "RelationshipCondition": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "chance"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "random_chance" },
            "chance": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "entity_exists" },
            "entity": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "relationshipKind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "entity_has_relationship" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "relationshipKind": { "$ref": "#/$defs/NonEmptyString" }
          }
        }
      ]
    },

    "StateUpdateRule": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": { "type": { "const": "update_rate_limit" } }
        },
        {
          "type": "object",
          "required": ["type", "entity", "relationshipKind", "with"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "archive_relationship" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "relationshipKind": { "$ref": "#/$defs/NonEmptyString" },
            "with": { "$ref": "#/$defs/NonEmptyString", "description": "Entity reference or 'any' to archive all relationships of this kind" },
            "direction": { "enum": ["src", "dst", "any"], "default": "any", "description": "Only used when with='any': which end of the relationship the entity should be on" }
          }
        },
        {
          "type": "object",
          "required": ["type", "pressureId", "delta"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "modify_pressure" },
            "pressureId": { "$ref": "#/$defs/NonEmptyString" },
            "delta": { "type": "number" }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "newStatus"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "update_entity_status" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "newStatus": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "set_tag" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "tag": { "$ref": "#/$defs/NonEmptyString" },
            "value": { "oneOf": [{ "type": "string" }, { "type": "boolean" }] }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "remove_tag" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "tag": { "$ref": "#/$defs/NonEmptyString" }
          }
        }
      ]
    },

    "VariableDefinition": {
      "type": "object",
      "required": ["select"],
      "additionalProperties": false,
      "properties": {
        "select": { "$ref": "#/$defs/VariableSelectionRule" },
        "required": { "type": "boolean", "description": "If true, template won't run unless this variable resolves" }
      }
    },

    "VariableSelectionRule": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "from": {
          "oneOf": [
            { "$ref": "#/$defs/RelatedEntitiesSpec" },
            { "const": "graph" }
          ]
        },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "subtypes": { "type": "array", "items": { "$ref": "#/$defs/NonEmptyString" }, "minItems": 1 },
        "statusFilter": { "$ref": "#/$defs/NonEmptyString" },
        "filters": { "type": "array", "items": { "$ref": "#/$defs/SelectionFilter" } },
        "preferFilters": { "type": "array", "items": { "$ref": "#/$defs/SelectionFilter" } },
        "pickStrategy": { "enum": ["random", "first", "all"] },
        "fallback": { "$ref": "#/$defs/NonEmptyString" }
      }
    },

    "RelatedEntitiesSpec": {
      "type": "object",
      "required": ["relatedTo", "relationship", "direction"],
      "additionalProperties": false,
      "properties": {
        "relatedTo": { "$ref": "#/$defs/NonEmptyString" },
        "relationship": { "$ref": "#/$defs/NonEmptyString" },
        "direction": { "enum": ["src", "dst", "both"] }
      }
    },

    "TemplateVariants": {
      "type": "object",
      "required": ["selection", "options"],
      "additionalProperties": false,
      "properties": {
        "selection": { "enum": ["first_match", "all_matching"] },
        "options": { "type": "array", "items": { "$ref": "#/$defs/TemplateVariant" }, "minItems": 1 }
      }
    },

    "TemplateVariant": {
      "type": "object",
      "required": ["name", "when", "apply"],
      "additionalProperties": false,
      "properties": {
        "name": { "$ref": "#/$defs/NonEmptyString" },
        "when": { "$ref": "#/$defs/VariantCondition" },
        "apply": { "$ref": "#/$defs/VariantEffects" }
      }
    },

    "VariantCondition": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "pressureId"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "pressure" },
            "pressureId": { "$ref": "#/$defs/NonEmptyString" },
            "min": { "type": "number", "minimum": 0, "maximum": 100 },
            "max": { "type": "number", "minimum": 0, "maximum": 100 }
          }
        },
        {
          "type": "object",
          "required": ["type", "pressureA", "pressureB"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "pressure_compare" },
            "pressureA": { "$ref": "#/$defs/NonEmptyString" },
            "pressureB": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "kind"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "entity_count" },
            "kind": { "$ref": "#/$defs/NonEmptyString" },
            "subtype": { "$ref": "#/$defs/NonEmptyString" },
            "min": { "type": "integer", "minimum": 0 },
            "max": { "type": "integer", "minimum": 0 }
          }
        },
        {
          "type": "object",
          "required": ["type", "entity", "tag"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "has_tag" },
            "entity": { "$ref": "#/$defs/NonEmptyString" },
            "tag": { "$ref": "#/$defs/NonEmptyString" }
          }
        },
        {
          "type": "object",
          "required": ["type", "chance"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "random" },
            "chance": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "always" }
          }
        },
        {
          "type": "object",
          "required": ["type", "conditions"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "and" },
            "conditions": { "type": "array", "items": { "$ref": "#/$defs/VariantCondition" }, "minItems": 1 }
          }
        },
        {
          "type": "object",
          "required": ["type", "conditions"],
          "additionalProperties": false,
          "properties": {
            "type": { "const": "or" },
            "conditions": { "type": "array", "items": { "$ref": "#/$defs/VariantCondition" }, "minItems": 1 }
          }
        }
      ]
    },

    "VariantEffects": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "subtype": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/NonEmptyString" },
          "description": "Override subtype for created entities. Key is entityRef (e.g., $location)"
        },
        "tags": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": { "type": "boolean" }
          },
          "description": "Additional tags to add. Key is entityRef, value is tag map"
        },
        "relationships": {
          "type": "array",
          "items": { "$ref": "#/$defs/RelationshipRule" },
          "description": "Additional relationships to create"
        },
        "stateUpdates": {
          "type": "array",
          "items": { "$ref": "#/$defs/StateUpdateRule" },
          "description": "Additional state updates to apply"
        }
      }
    }
  }
}
