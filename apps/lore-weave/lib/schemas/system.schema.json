{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "system.schema.json",
  "title": "DeclarativeSystem",
  "description": "A declarative system definition for world simulation",
  "oneOf": [
    { "$ref": "#/$defs/ConnectionEvolutionSystem" },
    { "$ref": "#/$defs/GraphContagionSystem" },
    { "$ref": "#/$defs/ThresholdTriggerSystem" },
    { "$ref": "#/$defs/ClusterFormationSystem" },
    { "$ref": "#/$defs/TagDiffusionSystem" },
    { "$ref": "#/$defs/PlaneDiffusionSystem" },
    { "$ref": "#/$defs/EraSpawnerSystem" },
    { "$ref": "#/$defs/EraTransitionSystem" },
    { "$ref": "#/$defs/UniversalCatalystSystem" },
    { "$ref": "#/$defs/RelationshipMaintenanceSystem" },
    { "$ref": "#/$defs/GrowthSystem" }
  ],
  "$defs": {
    "BaseConfig": {
      "type": "object",
      "required": ["id"],
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for this system" },
        "name": { "type": "string", "description": "Human-readable name" },
        "description": { "type": "string", "description": "Description of what this system does" },
        "enabled": { "type": "boolean", "description": "Whether this system is active (default: true)" }
      }
    },

    "ConnectionEvolutionSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "connectionEvolution" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "required": ["entityKind", "metric", "rules"],
              "properties": {
                "entityKind": { "type": "string", "description": "Entity kind to operate on, or 'any' for all kinds" },
                "entitySubtypes": { "type": "array", "items": { "type": "string" }, "description": "Only evaluate these subtypes" },
                "entityStatus": { "type": "string", "description": "Only evaluate entities with this status" },
                "metric": { "$ref": "#/$defs/ConnectionMetric" },
                "rules": {
                  "type": "array",
                  "items": { "$ref": "#/$defs/EvolutionRule" }
                },
                "subtypeBonuses": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["subtype", "bonus"],
                    "properties": {
                      "subtype": { "type": "string" },
                      "bonus": { "type": "number" }
                    }
                  },
                  "description": "Bonuses added to metric value based on entity subtype"
                },
                "throttleChance": { "type": "number", "minimum": 0, "maximum": 1 },
                "pressureChanges": { "$ref": "#/$defs/PressureChanges" }
              }
            }
          ]
        }
      }
    },

    "GraphContagionSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "graphContagion" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "required": ["entityKind", "contagion", "vectors", "transmission", "infectionAction"],
              "properties": {
                "entityKind": { "type": "string", "description": "Entity kind to operate on, or 'any' for all kinds" },
                "contagion": {
                  "type": "object",
                  "required": ["type"],
                  "properties": {
                    "type": { "enum": ["tag", "relationship"] },
                    "tag": { "type": "string" },
                    "relationshipKind": { "type": "string" }
                  }
                },
                "vectors": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["relationshipKind"],
                    "properties": {
                      "relationshipKind": { "type": "string" },
                      "direction": { "enum": ["src", "dst", "both"] },
                      "minStrength": { "type": "number", "minimum": 0, "maximum": 1 }
                    }
                  }
                },
                "transmission": {
                  "type": "object",
                  "properties": {
                    "baseRate": { "type": "number", "minimum": 0, "maximum": 1 },
                    "contactMultiplier": { "type": "number" },
                    "maxProbability": { "type": "number", "minimum": 0, "maximum": 1 }
                  }
                },
                "infectionAction": {
                  "type": "object",
                  "required": ["type"],
                  "properties": {
                    "type": { "enum": ["set_tag", "create_relationship"] },
                    "tag": { "type": "string" },
                    "value": {},
                    "relationshipKind": { "type": "string" },
                    "strength": { "type": "number", "minimum": 0, "maximum": 1 }
                  }
                },
                "cooldown": { "type": "number" },
                "throttleChance": { "type": "number", "minimum": 0, "maximum": 1 },
                "pressureChanges": { "$ref": "#/$defs/PressureChanges" }
              }
            }
          ]
        }
      }
    },

    "ThresholdTriggerSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "thresholdTrigger" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "required": ["entityFilter", "conditions", "actions"],
              "properties": {
                "entityFilter": {
                  "type": "object",
                  "required": ["kind"],
                  "properties": {
                    "kind": { "type": "string", "description": "Entity kind to evaluate, or 'any' for all kinds" },
                    "subtypes": { "type": "array", "items": { "type": "string" } },
                    "status": { "type": "string" },
                    "notStatus": { "type": "string" },
                    "hasTag": { "type": "string" },
                    "notHasTag": { "type": "string" }
                  }
                },
                "conditions": {
                  "type": "array",
                  "items": { "$ref": "#/$defs/TriggerCondition" }
                },
                "actions": {
                  "type": "array",
                  "items": { "$ref": "#/$defs/TriggerAction" }
                },
                "clusterMode": { "enum": ["individual", "all_matching", "by_relationship"] },
                "clusterRelationshipKind": { "type": "string" },
                "minClusterSize": { "type": "number", "minimum": 1 },
                "throttleChance": { "type": "number", "minimum": 0, "maximum": 1 },
                "cooldownTag": { "type": "string" },
                "cooldownTicks": { "type": "number", "minimum": 0 },
                "pressureChanges": { "$ref": "#/$defs/PressureChanges" }
              }
            }
          ]
        }
      }
    },

    "ClusterFormationSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "clusterFormation" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "required": ["entityFilter", "clustering", "metaEntity"],
              "properties": {
                "entityFilter": {
                  "type": "object",
                  "required": ["kind"],
                  "properties": {
                    "kind": { "type": "string", "description": "Entity kind to cluster, or 'any' for all kinds" },
                    "subtypes": { "type": "array", "items": { "type": "string" } },
                    "excludeSubtypes": { "type": "array", "items": { "type": "string" } },
                    "status": { "type": "string" }
                  }
                },
                "runAtEpochEnd": { "type": "boolean", "description": "Whether to only run at epoch end" },
                "clustering": {
                  "type": "object",
                  "required": ["minSize", "criteria", "minimumScore"],
                  "properties": {
                    "minSize": { "type": "number", "minimum": 2 },
                    "maxSize": { "type": "number" },
                    "criteria": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "required": ["type", "weight"],
                        "properties": {
                          "type": { "enum": ["shared_relationship", "same_culture", "shared_tags", "temporal_proximity"] },
                          "weight": { "type": "number" },
                          "threshold": { "type": "number" },
                          "relationshipKind": { "type": "string", "description": "For shared_relationship type" },
                          "direction": { "enum": ["src", "dst"], "description": "For shared_relationship type" }
                        }
                      }
                    },
                    "minimumScore": { "type": "number" }
                  }
                },
                "metaEntity": {
                  "type": "object",
                  "required": ["kind", "status"],
                  "properties": {
                    "kind": { "type": "string", "description": "Kind for the meta-entity" },
                    "subtypeFromMajority": { "type": "boolean", "description": "Use majority subtype from cluster" },
                    "fixedSubtype": { "type": "string", "description": "Fixed subtype if subtypeFromMajority is false" },
                    "status": { "type": "string", "description": "Status for the meta-entity" },
                    "prominenceFromSize": {
                      "type": "object",
                      "properties": {
                        "marginal": { "type": "number" },
                        "recognized": { "type": "number" },
                        "renowned": { "type": "number" }
                      }
                    },
                    "additionalTags": { "type": "array", "items": { "type": "string" } },
                    "descriptionTemplate": { "type": "string", "description": "Use {count} for cluster size, {names} for entity names" }
                  }
                },
                "postProcess": {
                  "type": "object",
                  "properties": {
                    "createGovernanceFaction": { "type": "boolean" },
                    "governanceFactionSubtype": { "type": "string" },
                    "governanceRelationship": { "type": "string" },
                    "pressureChanges": { "$ref": "#/$defs/PressureChanges" },
                    "createEmergentRegion": { "type": "boolean" },
                    "emergentRegionLabel": { "type": "string" },
                    "emergentRegionDescription": { "type": "string" }
                  }
                }
              }
            }
          ]
        }
      }
    },

    "TagDiffusionSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "tagDiffusion" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "required": ["entityKind", "connectionKind"],
              "properties": {
                "entityKind": { "type": "string", "description": "Entity kind to evaluate, or 'any' for all kinds" },
                "entitySubtype": { "type": "string", "description": "Only evaluate entities with this subtype" },
                "entityStatus": { "type": "string", "description": "Only evaluate entities with this status" },
                "connectionKind": { "type": "string", "description": "Relationship kind that indicates connection between entities" },
                "connectionDirection": { "enum": ["src", "dst", "both"], "description": "Direction to check for connections" },
                "convergence": {
                  "type": "object",
                  "required": ["tags", "minConnections", "probability"],
                  "properties": {
                    "tags": { "type": "array", "items": { "type": "string" }, "description": "Tags that can be added to connected entities" },
                    "minConnections": { "type": "number", "minimum": 0, "description": "Minimum connections required to trigger convergence" },
                    "probability": { "type": "number", "minimum": 0, "maximum": 1, "description": "Probability of adding a convergence tag per tick" },
                    "maxSharedTags": { "type": "number", "description": "Maximum shared tags before stopping convergence" }
                  }
                },
                "divergence": {
                  "type": "object",
                  "required": ["tags", "maxConnections", "probability"],
                  "properties": {
                    "tags": { "type": "array", "items": { "type": "string" }, "description": "Tags that can be added to isolated entities" },
                    "maxConnections": { "type": "number", "minimum": 0, "description": "Maximum connections to count as isolated" },
                    "probability": { "type": "number", "minimum": 0, "maximum": 1, "description": "Probability of adding a divergence tag per tick" }
                  }
                },
                "maxTags": { "type": "number", "description": "Maximum tags per entity to prevent tag bloat" },
                "throttleChance": { "type": "number", "minimum": 0, "maximum": 1 },
                "pressureChanges": { "$ref": "#/$defs/PressureChanges" },
                "divergencePressure": {
                  "type": "object",
                  "required": ["pressureName", "minDivergent", "delta"],
                  "properties": {
                    "pressureName": { "type": "string", "description": "Pressure name to modify" },
                    "minDivergent": { "type": "number", "description": "Minimum divergent entities to trigger pressure" },
                    "delta": { "type": "number", "description": "Pressure delta when triggered" }
                  }
                }
              }
            }
          ]
        }
      }
    },

    "PlaneDiffusionSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "description": "True time-evolving 2D diffusion field simulation. Uses a 100x100 grid matching the semantic coordinate space. Sources SET values at their positions (Dirichlet boundary), then values diffuse via heat equation. Simulation runs uncapped internally; values are clamped to -100 to 100 only at output (tags).",
      "properties": {
        "systemType": { "const": "planeDiffusion" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "required": ["entityKind", "sources", "diffusion", "outputTags"],
              "properties": {
                "entityKind": { "type": "string", "description": "Entity kind to operate on (defines the semantic plane)" },
                "entityStatus": { "type": "string", "description": "Only process entities with this status" },
                "sources": {
                  "type": "object",
                  "required": ["tagFilter", "defaultStrength"],
                  "description": "Entities that emit values into the diffusion field. Sources SET their value each tick (Dirichlet boundary condition).",
                  "properties": {
                    "tagFilter": { "type": "string", "description": "Tag that marks an entity as a source" },
                    "strengthTag": { "type": "string", "description": "Optional tag containing numeric strength value (e.g., 'strength:50')" },
                    "defaultStrength": {
                      "type": "number",
                      "description": "Source strength value. Can be any number - simulation is uncapped. Values are clamped to -100 to 100 only when applied to entity tags."
                    }
                  }
                },
                "sinks": {
                  "type": "object",
                  "required": ["tagFilter", "defaultStrength"],
                  "description": "Entities that absorb values from the diffusion field. Sinks SET negative values at their positions.",
                  "properties": {
                    "tagFilter": { "type": "string", "description": "Tag that marks an entity as a sink" },
                    "strengthTag": { "type": "string", "description": "Optional tag containing numeric strength value" },
                    "defaultStrength": {
                      "type": "number",
                      "description": "Sink strength (will be negated). Can be any number - simulation is uncapped."
                    }
                  }
                },
                "diffusion": {
                  "type": "object",
                  "required": ["rate"],
                  "description": "Parameters controlling the heat equation discretization",
                  "properties": {
                    "rate": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1,
                      "description": "Diffusion coefficient (0-1). Controls how fast values spread to neighbors each tick. Recommended: 0.1-0.25. Values above 0.25 may cause numerical instability."
                    },
                    "sourceRadius": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 50,
                      "default": 1,
                      "description": "Radius in grid cells around source/sink where values are directly SET. Default: 1. Larger values create broader fixed-value zones."
                    },
                    "decayRate": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1,
                      "default": 0,
                      "description": "How fast values decay toward zero each tick (0-1). Default: 0 (no decay). Use sparingly - decay fights against diffusion spreading."
                    },
                    "falloffType": {
                      "type": "string",
                      "enum": ["absolute", "none", "linear", "inverse_square", "sqrt", "exponential"],
                      "default": "absolute",
                      "description": "How source strength decreases within sourceRadius. absolute: strength-distance (100→99→98), none: full strength everywhere, linear/sqrt/etc: percentage-based falloff"
                    },
                    "iterationsPerTick": {
                      "type": "number",
                      "minimum": 1,
                      "maximum": 200,
                      "default": 20,
                      "description": "Number of diffusion iterations per tick. Higher values = faster spreading. Default: 20 (achieves ~50 cell spread in 15 ticks)."
                    }
                  }
                },
                "outputTags": {
                  "type": "array",
                  "description": "Tags applied to entities based on their sampled field value (clamped to -100 to 100)",
                  "items": {
                    "type": "object",
                    "required": ["tag"],
                    "properties": {
                      "tag": { "type": "string", "description": "Tag to set on entity when field value is in range" },
                      "minValue": { "type": "number", "minimum": -100, "maximum": 100, "description": "Minimum field value to set this tag (inclusive). Range: -100 to 100." },
                      "maxValue": { "type": "number", "minimum": -100, "maximum": 100, "description": "Maximum field value to set this tag (exclusive). Range: -100 to 100." }
                    }
                  }
                },
                "valueTag": { "type": "string", "description": "Optional: store clamped field value as a tag (e.g., 'field_value' → 'field_value:25.5')" },
                "throttleChance": { "type": "number", "minimum": 0, "maximum": 1, "description": "Probability of running this system each tick (0-1). Default: 1.0 (every tick)." },
                "pressureChanges": { "$ref": "#/$defs/PressureChanges" }
              }
            }
          ]
        }
      }
    },

    "EraSpawnerSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "eraSpawner" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "properties": {
                "ticksPerEra": { "type": "number", "minimum": 1 }
              }
            }
          ]
        }
      }
    },

    "EraTransitionSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "eraTransition" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "properties": {
                "minTicksBeforeTransition": { "type": "number" }
              }
            }
          ]
        }
      }
    },

    "UniversalCatalystSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "universalCatalyst" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "properties": {
                "actionAttemptRate": { "type": "number", "minimum": 0, "maximum": 1 },
                "pressureMultiplier": { "type": "number" },
                "prominenceUpChanceOnSuccess": { "type": "number", "minimum": 0, "maximum": 1 },
                "prominenceDownChanceOnFailure": { "type": "number", "minimum": 0, "maximum": 1 }
              }
            }
          ]
        }
      }
    },

    "RelationshipMaintenanceSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "relationshipMaintenance" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "properties": {
                "maintenanceFrequency": { "type": "number", "minimum": 1 },
                "cullThreshold": { "type": "number", "minimum": 0, "maximum": 1 },
                "gracePeriod": { "type": "number", "minimum": 0 },
                "reinforcementBonus": { "type": "number" },
                "maxStrength": { "type": "number", "minimum": 0, "maximum": 1 },
                "proximityRelationshipKinds": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "Relationship kinds that indicate entities are in proximity for reinforcement"
                }
              }
            }
          ]
        }
      }
    },

    "GrowthSystem": {
      "type": "object",
      "required": ["systemType", "config"],
      "properties": {
        "systemType": { "const": "growth" },
        "config": {
          "allOf": [
            { "$ref": "#/$defs/BaseConfig" },
            {
              "type": "object",
              "properties": {
                "maxTemplatesPerTick": { "type": "number", "minimum": 0, "description": "Hard cap on template executions per tick" },
                "minTemplatesPerTick": { "type": "number", "minimum": 0, "description": "Minimum template executions per tick while growth is needed" },
                "yieldAveragingWindow": { "type": "number", "minimum": 1, "description": "Rolling window size for average entities per template" },
                "maxAttemptsPerTick": { "type": "number", "minimum": 1, "description": "Safety limit on template selection attempts per tick" }
              }
            }
          ]
        }
      }
    },

    "ConnectionMetric": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "enum": ["connection_count", "relationship_count", "shared_relationship", "catalyzed_events"] },
        "relationshipKinds": { "type": "array", "items": { "type": "string" } },
        "direction": { "enum": ["src", "dst", "both"] },
        "sharedRelationshipKind": { "type": "string" },
        "sharedDirection": { "enum": ["src", "dst"] },
        "minStrength": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "EvolutionRule": {
      "type": "object",
      "required": ["condition", "probability", "action"],
      "properties": {
        "condition": {
          "type": "object",
          "required": ["operator", "threshold"],
          "properties": {
            "operator": { "enum": [">=", ">", "<=", "<", "=="] },
            "threshold": {
              "oneOf": [
                { "type": "number" },
                { "const": "prominence_scaled" }
              ]
            },
            "multiplier": { "type": "number", "description": "Multiplier for prominence_scaled threshold (default: 6)" }
          }
        },
        "probability": { "type": "number", "minimum": 0, "maximum": 1 },
        "action": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": { "enum": ["adjust_prominence", "create_relationship", "change_status", "add_tag"] },
            "direction": { "enum": ["up", "down"], "description": "For adjust_prominence" },
            "kind": { "type": "string", "description": "For create_relationship" },
            "category": { "type": "string", "description": "For create_relationship" },
            "strength": { "type": "number", "minimum": 0, "maximum": 1, "description": "For create_relationship" },
            "newStatus": { "type": "string", "description": "For change_status" },
            "tag": { "type": "string", "description": "For add_tag" },
            "value": { "description": "For add_tag" }
          }
        },
        "betweenMatching": { "type": "boolean", "description": "For create_relationship: pair entities that both pass condition" }
      }
    },

    "TriggerCondition": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "enum": ["relationship_count", "relationship_exists", "entity_status", "tag_exists", "tag_absent", "pressure_above", "pressure_below", "time_since_update", "connection_count"] },
        "relationshipKind": { "type": "string", "description": "For relationship_count, relationship_exists" },
        "relationshipDirection": { "enum": ["src", "dst", "both"], "description": "For relationship_count" },
        "minCount": { "type": "number", "description": "For relationship_count" },
        "maxCount": { "type": "number", "description": "For relationship_count" },
        "targetKind": { "type": "string", "description": "For relationship_exists" },
        "targetStatus": { "type": "string", "description": "For relationship_exists" },
        "status": { "type": "string", "description": "For entity_status" },
        "notStatus": { "type": "string", "description": "For entity_status" },
        "tag": { "type": "string", "description": "For tag_exists, tag_absent" },
        "pressureId": { "type": "string", "description": "For pressure_above, pressure_below" },
        "threshold": { "type": "number", "description": "For pressure_above, pressure_below" },
        "minTicks": { "type": "number", "description": "For time_since_update" },
        "minConnections": { "type": "number", "description": "For connection_count" },
        "maxConnections": { "type": "number", "description": "For connection_count" }
      }
    },

    "TriggerAction": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "enum": ["set_tag", "set_cluster_tag", "remove_tag", "modify_pressure", "create_relationship"] },
        "tag": { "type": "string", "description": "For set_tag, set_cluster_tag, remove_tag" },
        "tagValue": { "description": "For set_tag, set_cluster_tag" },
        "pressureId": { "type": "string", "description": "For modify_pressure" },
        "delta": { "type": "number", "description": "For modify_pressure" },
        "relationshipKind": { "type": "string", "description": "For create_relationship" },
        "relationshipStrength": { "type": "number", "minimum": 0, "maximum": 1, "description": "For create_relationship" },
        "betweenMatching": { "type": "boolean", "description": "For create_relationship: create between all matching entities" }
      }
    },

    "PressureChanges": {
      "type": "object",
      "additionalProperties": { "type": "number" },
      "description": "Map of pressure ID to delta value"
    }
  }
}
