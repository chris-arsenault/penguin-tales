name: Build, package, and notify deployer

on:
  push:
    branches: [ main ]

permissions:
  contents: write      # create release + upload asset
  actions: write       # send repository_dispatch to websites

jobs:
  build-package-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build app
        run: npm run build
        # assume output in ./build; change if you use ./dist or something else

      - name: Package build output
        run: |
          mkdir -p artifacts
          tar -czf artifacts/site.tar.gz build
        # contents: build/** inside site.tar.gz

      - name: Create Git tag name
        id: tag
        run: |
          # You can change this strategy if you use real version tags
          TAG="deploy-${GITHUB_SHA}"
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release with asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "Deploy ${{ steps.tag.outputs.tag_name }}"
          draft: false
          prerelease: false
          files: artifacts/site.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify websites repo to deploy from release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const websitesRepo = 'websites'; // repo name only
            const owner = context.repo.owner; // assuming same org/user

            await github.rest.repos.createDispatchEvent({
              owner,
              repo: websitesRepo,
              event_type: 'deploy_from_release',
              client_payload: {
                app_repo: `${context.repo.owner}/${context.repo.repo}`,
                app_name: 'app-a', // change per app
                tag_name: `${{ steps.tag.outputs.tag_name }}`,
                asset_name: 'site.tar.gz',
                environment: 'prod'
              }
            });
